<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href="poker.css"> -->
</head>
<style>
    .player {
        border: 1px solid black;
        width: 200px;
        height: 200px;
        margin: 10px;
        padding: 10px;
        display: inline-block;
    }
    .container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    #dealBtn {
        margin: 10px;
        width: 100px;
    }
    .player .cards {
        margin-top: 10px;
    }
    .player button {
        margin-top: 5px;
        margin-bottom: 5px;
    }
    .table-cards {
        text-align: center;
        margin-bottom: 10px;
    }
    .bet-amt-con, .total-table-bet-con {
        text-align: center;
        margin-bottom: 20px;
    }
</style>
<body>
    <div class="container">
        <h1>Poker game</h1>
        <button id="dealBtn" onclick="deal()"> Deal </button>
        <h2>Total players - <span id="total-players">0</span></h2>
        <button id="addPlayerBtn" onclick="addPlayer()">Add Player</button>
        <div class="players" style="display: none;">   
            
        </div>
        <div class="community-cards" style="display: none;">
            <h2>Cards on the table</h2>
            <div class="table-cards">Cards</div>
            <div class="bet-amt-con">Bet amount: $<span id="bet-amt"></span></div>
            <div class="total-table-bet-con">Total bets on table: $<span class="total-table-bet">0</span></div>
        </div>
        <button id="restartBtn" onclick="window.location.reload()" style="display: none;">Restart</button>
        <button id="nextBtn" onclick="reDeal()" style="display: none;">Next</button>
    </div>
    <script>
        let playerCount = 0;
        let betAmount = 2000;
        let totalTable = 0;
        let allPlayers = [];
        let raised = false;
        let turn = 1;
        let initialTotal = 50000;
        let playersTotal = [];
        let playerCards = [];
        let foldedPlayers = [];
        let whoRaised = 0;
        let round = 0;
        let gameEnded = false;
        cardNum = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
        cardSuit = ["♠", "♣", "♥", "♦"];
        function addPlayer(){
            playerCount++;
            allPlayers.push(playerCount);
            playersTotal.push({player: playerCount, total: initialTotal});
            document.getElementById("total-players").innerHTML = playerCount;
            const playersContainer = document.querySelector(".players");
            const playerDiv = document.createElement("div");
            playerDiv.classList.add("player");
            playerDiv.id = `player-${playerCount}`;
            playerDiv.innerHTML = `
                <span id="tag-${playerCount}">Player ${playerCount} - </span>
                <span id="total-${playerCount}"></span>
                <div class="cards">Cards</div>
                <button onclick="fold(${playerCount})" class="actionBtn-${playerCount}" id="foldBtn-${playerCount}">Fold</button>
                <button onclick="check(${playerCount})" class="actionBtn-${playerCount}" id="callBtn-${playerCount}">Check</button>
                <button onclick="promptRaise(${playerCount})" class="actionBtn-${playerCount}" id="raisePrmt-${playerCount}">Raise</button>
                <br>
                <div class="raiseCtn-${playerCount}" style="display: none;">
                    <label for="raiseAmt-${playerCount}">Raise amount: </label>
                    <input type="number" id="raiseAmt-${playerCount}" name="raiseAmt">
                    <button id="raiseBtn" onclick="raise(${playerCount})">Raise</button>
                </div>
                <div class="status-${playerCount}">Status: Playing</div>
            `;
            playersContainer.appendChild(playerDiv);

            
        }
        function checkTurn(pl){
            if(pl > 1){
                lastPl = pl - 1
                let raiseCtn = document.querySelector(".raiseCtn-" + lastPl);
                raiseCtn.style.display = "none";
            }
            if (foldedPlayers.includes(pl)){
                pl++;
                turn++;
                console.log("folded")
                checkTurn(pl);
                return
            }
            if (pl > 1){
                let prevPlayer = document.getElementById("tag-" + (pl - 1));
                prevPlayer.style.color = "black";
            }
            if (pl > playerCount){
                pl = 1;
                turn = 1;
                console.log("pl > playerCount")
                console.log("playerCards", playerCards)
                if (whoRaised == 0){
                    betAmount = 2000;
                    document.getElementById("bet-amt").innerHTML = betAmount;
                }
                checkTurn(pl);
                addOneCard();
                return
            }
            let currentPlayer = document.getElementById("tag-" + pl);
            currentPlayer.style.color = "blue";
            if (whoRaised == pl){
                checkCallText(pl, false);
                whoRaised = 0;
                betAmount = 2000;
                document.getElementById("bet-amt").innerHTML = betAmount;
            }
            return
        }
        function promptRaise(pl){
            if (turn != pl){
                alert("It's not your turn");
                return;
            }
            let raiseCtn = document.querySelector(".raiseCtn-" + pl);
            if (raiseCtn.style.display == "block"){
                raiseCtn.style.display = "none";
                return
            }
            raiseCtn.style.display = "block";
        }
        function raise(pl){
            let raiseAmt = document.getElementById("raiseAmt-" + pl).value;
            const player = playersTotal.find(player => player.player === pl);
            raiseAmt = parseInt(raiseAmt);
            if (raiseAmt > player.total){
                alert("You don't have enough money");
                return;
            }
            if (raiseAmt % 1000 != 0){
                alert("Please enter a multiple of 1000");
                return;
            }
            betAmount += raiseAmt;
            player.total -= betAmount;
            totalTable += betAmount;
            const amt = document.getElementById("total-" + pl);
            amt.innerHTML = `Total: $${player.total}`;
            document.querySelector(".total-table-bet").innerHTML = totalTable;
            document.getElementById("bet-amt").innerHTML = betAmount;
            whoRaised = pl;
            checkCallText(pl, true);
            turn++;
            pl++;
            checkTurn(turn);
        }
        function checkCallText(pl, toCall) {
            if (!toCall) {
                allPlayers.forEach(playerId => {
                    const callBtn = document.getElementById(`callBtn-${playerId}`);
                    if (callBtn) {
                        callBtn.innerText = "Check";
                    }
                });
            }else{
                allPlayers.forEach(playerId => {
                    if (playerId !== pl) {
                        const callBtn = document.getElementById(`callBtn-${playerId}`);
                        if (callBtn) {
                            callBtn.innerText = "Call";
                        }
                    }else{
                        const callBtn = document.getElementById(`callBtn-${playerId}`);
                        if (callBtn) {
                            callBtn.innerText = "Check";
                        }
                    }
                });
            }
        }
        function addOneCard(){
            round++;
            if (round == 5){
                document.getElementById("nextBtn").style.display = "block";
                alert("Game over");
                calculateResult(playerCards);
                return;
            }
            let tableCards = document.querySelector(".table-cards");
            suit = cardSuit[Math.floor(Math.random() * 4)];
            plCard = cardNum[Math.floor(Math.random() * 13)];
            tableCard = plCard + suit
            let cardSpan = document.createElement("span");
            cardSpan.textContent = " " + tableCard;
            if (suit == "♦" || suit == "♥") {
                cardSpan.style.color = "red";
            }else{
                cardSpan.style.color = "black";
            }
            tableCards.appendChild(cardSpan);
            playerCards.forEach(playerCard => {
                playerCard.cards += ", " + plCard + suit;
            });
        }
        function deal(reDeal = false){
            console.log(turn)
            if(allPlayers.length < 2){
                alert("Add atleast 2 players");
                return;
            }
            console.log(turn)
            checkTurn(turn)
            console.log(turn)
            document.querySelector(".players").style.display = "block";
            document.querySelector(".community-cards").style.display = "block";
            if (!reDeal){
                allPlayers.forEach(player => {
                    let amt = document.getElementById("total-" + player);
                    amt.innerHTML = "Total: $" + initialTotal;
                });
            }
            let cards = document.querySelectorAll(".cards");
            for (let i = 0; i < cards.length; i++) {
                cards[i].innerHTML = "";
                let playerCardList = [];
                for (let j = 0; j < 2; j++) {
                    let card = document.createElement("div");
                    let suit = cardSuit[Math.floor(Math.random() * 4)];
                    let plCard = cardNum[Math.floor(Math.random() * 13)];
                    if (suit === "♦" || suit === "♥") {
                        card.style.color = "red";
                    }else{
                        card.style.color = "black";
                    }
                    card.innerHTML = plCard + suit;
                    playerCardList.push(plCard + suit);
                    cards[i].appendChild(card);
                }
                console.log("push players list")
                playerCards.push({ player: i + 1, cards: playerCardList.join(", ") });
            }
            document.getElementById("dealBtn").disabled = true;
            document.getElementById("addPlayerBtn").disabled = true;
            let tableCards = document.querySelector(".table-cards");
            suit = cardSuit[Math.floor(Math.random() * 4)];
            plCard = cardNum[Math.floor(Math.random() * 13)];
            tableCard = plCard + suit
            if (suit == "♦" || suit == "♥") {
                tableCards.style.color = "red";
            }else{
                tableCards.style.color = "black";
            }
            tableCards.innerHTML = tableCard;
            playerCards.forEach(playerCard => {
                playerCard.cards += ", " + plCard + suit;
            });
            document.getElementById("bet-amt").innerHTML = betAmount;
        }
        function reDeal(){
            turn = 1;
            foldedPlayers = [];
            round = 0;
            whoRaised = 0;
            refreshInfo();
            deal(true);
            // enableBtns();
        }
        function fold(pl){
            if (turn != pl){
                alert("It's not your turn");
                return;
            }
            turn++;
            checkTurn(turn);
            let actionBtns = document.querySelectorAll(".actionBtn-" + pl);
            for (let i = 0; i < actionBtns.length; i++) {
                actionBtns[i].disabled = true;
            }
            let status = document.querySelector(".status-" + pl);
            status.innerHTML = "Status: Folded";
            foldedPlayers.push(pl);
            gameStatus()
        }
        function check(pl){
            if (turn != pl){
                alert("It's not your turn");
                return;
            }
            const player = playersTotal.find(player => player.player === pl);
            player.total -= betAmount;
            totalTable += betAmount;
            const amt = document.getElementById("total-" + pl);
            amt.innerHTML = `Total: $${player.total}`;
            document.querySelector(".total-table-bet").innerHTML = totalTable;
            turn++;
            pl++
            checkTurn(turn);
        }
        function gameStatus(){
            if (foldedPlayers.length == playerCount - 1){
                allPlayers.forEach(pl => {
                    if (!foldedPlayers.includes(pl)){
                        let status = document.querySelector(".status-" + pl);
                        status.innerHTML = "Status: Won";
                        const player = playersTotal.find(player => player.player === pl);
                        player.total = player.total + totalTable;
                        const amt = document.getElementById("total-" + pl);
                        amt.innerHTML = `Total: $${player.total}`;
                        alert("Game over");
                        let playr = document.getElementById("tag-" + pl);
                        playr.style.color = "black";

                        document.getElementById("nextBtn").style.display = "block";
                    }
                })
            }
        }
        function calculateResult(playerCards) {
            const combos = playerCards.map(playerCard => combination(playerCard));
            const activeCombos = combos.filter(combo => !foldedPlayers.includes(combo.player));
            console.log(activeCombos);
            const winners = determineWinner(activeCombos);
            console.log(winners);
            resultInfo(combos, winners);
            disableBtns();
        }

        function determineWinner(players) {
            console.log("players", players)
            const handRanks = {
                "Royal Flush": 10,
                "Straight Flush": 9,
                "Four of a Kind": 8,
                "Full House": 7,
                "Flush": 6,
                "Straight": 5,
                "Three of a Kind": 4,
                "Two Pair": 3,
                "One Pair": 2,
                "High Card": 1
            };

            const cardValue = card => {
                if (card === "A") return 14;
                if (card === "K") return 13;
                if (card === "Q") return 12;
                if (card === "J") return 11;
                return parseInt(card);
            };

            const compareHands = (player1, player2) => {
                if (handRanks[player1.hand] > handRanks[player2.hand]) return 1;
                if (handRanks[player1.hand] < handRanks[player2.hand]) return -1;
                const cards1 = player1.cards.split(", ").map(card => cardValue(card.slice(0, -1)));
                const cards2 = player2.cards.split(", ").map(card => cardValue(card.slice(0, -1)));
                cards1.sort((a, b) => b - a); 
                cards2.sort((a, b) => b - a);
                for (let i = 0; i < Math.min(cards1.length, cards2.length); i++) {
                    if (cards1[i] > cards2[i]) return 1;
                    if (cards1[i] < cards2[i]) return -1;
                }
                return 0;
            };
            let bestPlayers = [players[0]];
            for (let i = 1; i < players.length; i++) {
                const comparison = compareHands(players[i], bestPlayers[0]);
                if (comparison > 0) {
                    bestPlayers = [players[i]]; 
                } else if (comparison === 0) {
                    bestPlayers.push(players[i]); 
                }
            }
            return bestPlayers.map(player => player.player);
        }


        function combination(playerCard) {
            let cards = playerCard.cards.split(", ");
            let playerNum = playerCard.player;
            let cardNum = [];
            let cardSuit = [];
            let cardMapping = []; 

            cards.forEach(card => {
                let value = card.slice(0, -1);
                let suit = card.slice(-1);
                if (value === "A") value = 14;
                else if (value === "K") value = 13;
                else if (value === "Q") value = 12;
                else if (value === "J") value = 11;

                value = parseInt(value);
                cardNum.push(value);
                cardSuit.push(suit);
                cardMapping.push({ value, suit }); 
            });

            cardMapping.sort((a, b) => b.value - a.value);

            const sortedCards = cardMapping.slice(0, 7)
                .map(card => `${card.value > 10 ? faceCardValue(card.value) : card.value}${card.suit}`)
                .join(", ");

            if (isFlush(cardSuit)) {
                if (isStraight(cardNum)) {
                    if (isRoyal(cardNum)) {
                        return { player: playerNum, cards: sortedCards, hand: "Royal Flush" };
                    }
                    return { player: playerNum, cards: sortedCards, hand: "Straight Flush" };
                }
                return { player: playerNum, cards: sortedCards, hand: "Flush" };
            } else if (isStraight(cardNum)) {
                return { player: playerNum, cards: sortedCards, hand: "Straight" };
            } else if (isFourOfAKind(cardNum)) {
                return { player: playerNum, cards: sortedCards, hand: "Four of a Kind" };
            } else if (isFullHouse(cardNum)) {
                return { player: playerNum, cards: sortedCards, hand: "Full House" };
            } else if (isThreeOfAKind(cardNum)) {
                return { player: playerNum, cards: sortedCards, hand: "Three of a Kind" };
            } else if (isTwoPair(cardNum)) {
                return { player: playerNum, cards: sortedCards, hand: "Two Pair" };
            } else if (isOnePair(cardNum)) {
                return { player: playerNum, cards: sortedCards, hand: "One Pair" };
            }

            // Default to High Card
            return { player: playerNum, cards: sortedCards, hand: "High Card" };
        }

        // convert numeric values back to face cards
        function faceCardValue(value) {
            switch (value) {
                case 11: return "J";
                case 12: return "Q";
                case 13: return "K";
                case 14: return "A";
                default: return value;
            }
        }


        // Helper Functions
        function isFlush(cardSuit) {
            const suitCounts = {};
            cardSuit.forEach(suit => suitCounts[suit] = (suitCounts[suit] || 0) + 1);
            return Object.values(suitCounts).some(count => count >= 5);
        }

        function isStraight(cardNum) {
            const uniqueCards = Array.from(new Set(cardNum));
            uniqueCards.sort((a, b) => b - a);

            let consecutiveCount = 1;
            for (let i = 0; i < uniqueCards.length - 1; i++) {
                if (uniqueCards[i] - uniqueCards[i + 1] === 1) {
                    consecutiveCount++;
                    if (consecutiveCount >= 5) return true;
                } else {
                    consecutiveCount = 1;
                }
            }
            return false;
        }

        function isRoyal(cardNum) {
            const royalCards = [14, 13, 12, 11, 10];
            return royalCards.every(card => cardNum.includes(card));
        }

        function isFourOfAKind(cardNum) {
            const counts = countOccurrences(cardNum);
            return Object.values(counts).some(count => count === 4);
        }

        function isFullHouse(cardNum) {
            const counts = countOccurrences(cardNum);
            const values = Object.values(counts);
            return values.includes(3) && values.includes(2);
        }

        function isThreeOfAKind(cardNum) {
            const counts = countOccurrences(cardNum);
            return Object.values(counts).some(count => count === 3);
        }

        function isTwoPair(cardNum) {
            const counts = countOccurrences(cardNum);
            return Object.values(counts).filter(count => count === 2).length >= 2;
        }

        function isOnePair(cardNum) {
            const counts = countOccurrences(cardNum);
            return Object.values(counts).some(count => count === 2);
        }

        function countOccurrences(array) {
            return array.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
        }

        function resultInfo(combinations, winners){
            combinations.forEach(combo => {
                let playerDiv = document.getElementById(`player-${combo.player}`);
                let handCards = document.createElement("div");
                handCards.id = "handCards-" + combo.player;
                handCards.innerHTML = "Cards: " + combo.cards;
                handCards.style.marginTop = "10px";
                playerDiv.appendChild(handCards);
                let hand = document.createElement("div");
                hand.id = "hand-" + combo.player;
                hand.innerHTML = "Hand: " + combo.hand;
                hand.style.fontWeight = "bold";
                hand.style.marginTop = "10px";
                playerDiv.appendChild(hand);
            });

            allPlayers.forEach(pl => {
              if (winners.length > 1) {
                if (winners.includes(pl)) {
                    let status = document.querySelector(".status-" + pl);
                    status.innerHTML = "Status: Won";
                } else {
                    let status = document.querySelector(".status-" + pl);
                    status.innerHTML = "Status: Lost";
                }
              } else {
                if (winners[0] == pl) {
                    let status = document.querySelector(".status-" + pl);
                    status.innerHTML = "Status: Won";
                    const player = playersTotal.find(player => player.player === pl);
                    player.total = player.total + totalTable;
                    const amt = document.getElementById("total-" + pl);
                    amt.innerHTML = `Total: $${player.total}`;
                } else {
                    let status = document.querySelector(".status-" + pl);
                    status.innerHTML = "Status: Lost";
                }
              }
              if (foldedPlayers.includes(pl)) {
                    let status = document.querySelector(".status-" + pl);
                    status.innerHTML = "Status: Folded";
              }
            });
        }

        function disableBtns(){
            allPlayers.forEach(player => {
                let actionBtns = document.querySelectorAll(".actionBtn-" + player);
                for (let i = 0; i < actionBtns.length; i++) {
                    actionBtns[i].disabled = true;
                }
                let pl = document.getElementById("tag-" + player);
                pl.style.color = "black";
            });
        }

        function enableBtns(){
            allPlayers.forEach(player => {
                let actionBtns = document.querySelectorAll(".actionBtn-" + player);
                for (let i = 0; i < actionBtns.length; i++) {
                    actionBtns[i].disabled = false;
                }
                let pl = document.getElementById("tag-" + player);
                pl.style.color = "black";
            });
        }
        function refreshInfo(){
            console.log("refresh")
            turn = 1;
            foldedPlayers = [];
            playerCards = [];
            document.querySelectorAll(".cards").innerHTML = '';
            round = 0;
            whoRaised = 0;
            allPlayers.forEach(player => {
                let status = document.querySelector(".status-" + player);
                status.innerHTML = "Status: Playing";
                let actionBtns = document.querySelectorAll(".actionBtn-" + player);
                for (let i = 0; i < actionBtns.length; i++) {
                    actionBtns[i].disabled = false;
                }
                let handCards = document.getElementById("handCards-" + player);
                if (handCards) handCards.remove();
                let hand = document.getElementById("hand-" + player);
                if (hand) hand.remove();
            });
            document.querySelector(".total-table-bet").innerHTML = 0;
            document.getElementById("bet-amt").innerHTML = 2000;
            document.getElementById("nextBtn").style.display = "none";
            document.getElementById("restartBtn").style.display = "none";
        }

    </script>
</body>
</html>
